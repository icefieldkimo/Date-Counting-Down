<script>
(function(){
  // --- Helpers ---
  const qs = new URLSearchParams(location.search);
  const tz = qs.get('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Taipei';
  document.getElementById('tzChip').textContent = `TZ: ${tz}`;

  function parseISO(s, fallbackHours=24){
    if (!s) return new Date(Date.now() + fallbackHours*3600*1000);
    const d = new Date(s);
    return isNaN(d) ? new Date(Date.now() + fallbackHours*3600*1000) : d;
  }
  const fmt = (d)=> new Intl.DateTimeFormat('zh-TW', {
    timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d);

  function tick(cfg){
    const now = new Date();
    const diff = cfg.until - now; // ms
    const total = (cfg.until - cfg.start);
    const clamped = Math.max(0, diff);

    const days = Math.floor(clamped / 86400000);
    const hours = Math.floor((clamped % 86400000) / 3600000);
    const mins = Math.floor((clamped % 3600000) / 60000);
    const secs = Math.floor((clamped % 60000) / 1000);

    cfg.el.d.textContent = days;
    cfg.el.h.textContent = String(hours).padStart(2,'0');
    cfg.el.m.textContent = String(mins).padStart(2,'0');
    cfg.el.s.textContent = String(secs).padStart(2,'0');

    if (!isNaN(total) && total > 0){
      const p = 100 * (1 - clamped / total);
      cfg.el.fill.style.width = Math.min(100, Math.max(0, p)) + '%';
    }

    if (diff <= 0){
      cfg.el.foot.textContent = "Time's up!";
    } else {
      cfg.el.foot.textContent = `Ends at ${cfg.until.toISOString()}`;
    }
  }

  function makeICS(title, start, end){
    const dt = d => d.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
    return [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Dual Public Countdown//EN',
      'BEGIN:VEVENT',
      `DTSTAMP:${dt(new Date())}`,
      `DTSTART:${dt(start)}`,
      `DTEND:${dt(end)}`,
      `SUMMARY:${title}`,
      'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
